<!DOCTYPE html>
<html lang="en">
<head>

    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-WLSQB5SF');</script>
    <!-- End Google Tag Manager -->

    <script>
        // --- GA4 Event Interceptor Script ---
        window.capturedGa4EventNames = window.capturedGa4EventNames || [];
        const MAX_DISPLAYED_EVENTS_IN_CONSOLE = 3;
        const MAX_STORED_EVENTS_IN_MEMORY = 20;
        let interceptorInitialized = false;
        
        // This will hold the reference to the "original" gtag function that our wrapper should call.
        // It might be updated if gtag is redefined (e.g. stub -> full function).
        let currentOriginalGtag = null; 

        function updateCustomConsoleDisplay() {
            const eventDisplaySpan = document.getElementById('console-message-gtm');
            if (!eventDisplaySpan) {
                return;
            }
            if (window.capturedGa4EventNames.length > 0) {
                eventDisplaySpan.textContent = window.capturedGa4EventNames.slice(-MAX_DISPLAYED_EVENTS_IN_CONSOLE).join(', ');
            } else {
                eventDisplaySpan.textContent = "(Waiting for GA4 events...)";
            }
        }

        function recordGa4Event(eventName, source) {
            if (typeof eventName !== 'string' || !eventName) return;
            console.log(`%c[Interceptor] GA4 Event: "${eventName}" (Source: ${source})`, "color: green; font-weight: bold;");
            window.capturedGa4EventNames.push(eventName);
            if (window.capturedGa4EventNames.length > MAX_STORED_EVENTS_IN_MEMORY) {
                window.capturedGa4EventNames.shift();
            }
            updateCustomConsoleDisplay();
        }

        function initializeGa4Interceptor() {
            if (interceptorInitialized) return;
            interceptorInitialized = true;
            console.log('[Interceptor] Initializing GA4 Interceptor...');

            // 1. Wrap dataLayer.push (for early calls to gtag stub that push arguments)
            if (window.dataLayer && typeof window.dataLayer.push === 'function') {
                const originalDataLayerPush = window.dataLayer.push;
                window.dataLayer.push = function(...pushedArgs) {
                    const firstArg = pushedArgs[0];
                    // Check if it's the `arguments` object from a gtag stub call
                    if (firstArg && typeof firstArg === 'object' && typeof firstArg.length === 'number' && 
                        firstArg[0] === 'event' && typeof firstArg[1] === 'string') {
                        recordGa4Event(firstArg[1], 'dataLayer.push (gtag arguments)');
                    }
                    return originalDataLayerPush.apply(window.dataLayer, pushedArgs);
                };
                console.log('[Interceptor] dataLayer.push has been wrapped.');
            } else {
                console.warn('[Interceptor] window.dataLayer.push not found for wrapping.');
            }

            // 2. Poll for and wrap/re-wrap window.gtag
            let gtagDirectWrapAttempts = 0;
            const maxGtagDirectWrapAttempts = 40; // ~20 seconds for GTM to fully load gtag

            function attemptDirectGtagWrap() {
                gtagDirectWrapAttempts++;
                // console.log(`[Interceptor] attemptDirectGtagWrap - Attempt #${gtagDirectWrapAttempts}`); // Can be noisy

                if (typeof window.gtag === 'function') {
                    // If window.gtag is a function AND it's not our current wrapper, then it needs wrapping/re-wrapping.
                    if (window.gtag.name !== 'interceptedGtagFunction') { 
                        console.log(`[Interceptor] Found window.gtag (name: ${window.gtag.name || 'anonymous'}). It's not our wrapper or has been reset. Storing and (re-)wrapping.`);
                        
                        currentOriginalGtag = window.gtag; // Store the *current* window.gtag we are about to wrap

                        window.gtag = function interceptedGtagFunction(...gtagArgs) {
                            console.log('%c[Interceptor] gtag WRAPPER CALLED. Arguments:', "color: blue; font-weight: bold;", gtagArgs);
                            
                            if (gtagArgs.length >= 1) {
                                const command = gtagArgs[0];
                                const eventName = gtagArgs[1];

                                if (command === 'event' && typeof eventName === 'string') {
                                    recordGa4Event(eventName, 'gtag (event)');
                                } else if (command === 'config' && typeof eventName === 'string' && eventName.startsWith('G-')) {
                                    let sendPageView = true;
                                    if (gtagArgs[2] && typeof gtagArgs[2].send_page_view === 'boolean') {
                                        sendPageView = gtagArgs[2].send_page_view;
                                    }
                                    if (sendPageView) {
                                        recordGa4Event('page_view', 'gtag (config)');
                                    }
                                    console.log('[Interceptor] gtag config call for:', eventName);
                                } else if (command === 'consent') {
                                    console.log('[Interceptor] gtag consent call:', gtagArgs);
                                    // You could optionally record a 'consent_update' event here for display if desired
                                    // recordGa4Event('consent_processed', 'gtag (consent)');
                                }
                            }

                            if (typeof currentOriginalGtag === 'function') {
                                return currentOriginalGtag.apply(this, gtagArgs);
                            } else {
                                console.error("[Interceptor] CRITICAL: Original gtag function reference (currentOriginalGtag) is lost!");
                                // This would be an issue. It implies currentOriginalGtag was not set correctly before wrapping.
                            }
                        };
                        console.log('[Interceptor] window.gtag has been REPLACED with our wrapper (interceptedGtagFunction).');
                    } else {
                        // console.log('[Interceptor] window.gtag is still our wrapper. No re-wrap needed on this attempt.');
                    }
                }

                // Continue polling if not all attempts used up, to catch late redefinitions of gtag
                if (gtagDirectWrapAttempts < maxGtagDirectWrapAttempts) {
                    setTimeout(attemptDirectGtagWrap, 500);
                } else {
                    if (typeof window.gtag !== 'function' || window.gtag.name !== 'interceptedGtagFunction') {
                         console.warn('[Interceptor] Max polling attempts reached. window.gtag might not be correctly wrapped or GTM did not load/redefine gtag as expected.');
                    } else {
                         console.log('[Interceptor] Max polling attempts reached. window.gtag appears to be our active wrapper.');
                    }
                }
            }
            attemptDirectGtagWrap(); // Start the polling
        }

        if (document.readyState === 'loading') {
            initializeGa4Interceptor();
        } else {
            initializeGa4Interceptor();
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateCustomConsoleDisplay();
            console.log('[Interceptor] DOMContentLoaded: Custom console display updated / verified.');
        });
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="images/favicon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon.png">

    <!-- Scripts -->
    <!-- <script src="js/gtm-ga4-interceptor.js?v=1"></script> -->
    <script src="js/config.js?v=3" defer></script>
    <script src="js/global-submit-handler.js?v=2" defer></script>

</head>
<body>

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WLSQB5SF"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <header>
        <div id="logo" class="logo">
            <img src="images/favicon.png" alt="Site Logo" class="logo-icon">
            Demo
        </div>
        <nav class="header-nav"> 
            <a href="#newsletter" class="header-link">Newsletter</a>
            <a href="contact.html" class="header-link">Contact</a>
        </nav>
    </header>
    
    <div class="content">

        <section id="hero" class="block" style="background-color: #fe6d6d;">
            <h1>Hero</h1>
            <div class="cta-group">
                <a href="#lead" class="cta-1">Get a quote</a>
                <a href="contact.html"  class="cta-2">Contact us</a>
            </div>
        </section>

        <section id="social-proof" class="block" style="background-color: #fe946d;">
            <h2>Social Proof</h2>
            <div class="cta-group">
                <a href="#lead" class="cta-1">Get a quote</a>
            </div>
        </section>

        <section id="problem" class="block" style="background-color: #ffcd4f;">
            <h2>Problem</h2>
            <div class="cta-group">
                <a href="#lead" class="cta-1">Get a quote</a>
            </div>
        </section>

        <section id="solution" class="block" style="background-color: #56c98f;">
            <h2>Solution</h2>
            <div class="cta-group">
                <a href="#lead" class="cta-1">Get a quote</a>
            </div>
        </section>

        <section id="case-study" class="block" style="background-color: #5cc1d7;">
            <h2>Case Study</h2>
            <div class="cta-group">
                <a href="#lead" class="cta-1">Get a quote</a>
            </div>
        </section>

        <section id="faq" class="block" style="background-color: #8ea5fa;">
            <h2>FAQ</h2>
            <div class="cta-group">
                <a href="#lead" class="cta-1">Get a quote</a>
            </div>
        </section>

        <section id="video" class="block" style="background-color: #f097fc;">
            <h2>Video</h2>

            <div class="iframe-wrapper" style="padding-top: 3rem;">
                <iframe 
                    src="https://www.youtube.com/embed/3apbS5OBuaA?enablejsapi=1" 
                    title="YouTube video player" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                    referrerpolicy="strict-origin-when-cross-origin" 
                    allowfullscreen
                    id="video-iframe">
                </iframe>
            </div>
            
            <div class="cta-group">
                <a href="#lead" class="cta-1">Get a quote</a>
            </div>
        </section>

        <section id="lead" class="block" style="background-color: #fc97c6;">
            <h2>Lead Form</h2>
            <form id="form-lead" 
                  action="" method="post"
                  class="form-1" 
                  style="padding-top: 3rem;">
                <label for="phone">Phone</label>
                <input name="form-id" type="hidden" value="form-lead">
                <input id="phone" type="tel" name="phone" placeholder="+1 (555) 123-4567" required>
                <label for="email">Email</label>
                <input id="email" type="email" name="email" placeholder="john.doe@example.com" required>
                <label for="company">Company</label>
                <input id="company" type="text" name="company" placeholder="Acme Corp." required>
                <label for="message">Message</label>
                <textarea id="message" name="message" placeholder="I'm interested in your services." rows="4" required></textarea>
                <button id="form-lead-button" type="submit" class="form-1-button-submit">Lead submit</button>
            </form>
        </section>

        <section id="newsletter" class="block" style="background-color: #fc9797;">
            <h2>Newsletter Form</h2>
            <div class="card-group" style="display: none;">
                <div id="message-newsletter" class="card message-success">
                </div>
            </div>
            <form id="form-newsletter"
                  action="" method="post" 
                  class="form-1" 
                  style="padding-top: 3rem;">
                <label for="email">Email</label>
                <input name="form-id" type="hidden" value="form-newsletter">
                <input id="email" type="email" name="email" placeholder="john.doe@example.com" required>
                <button id="form-newsletter-button" type="submit" class="form-1-button-submit">Newsletter submit</button>
            </form>
        </section>

       <footer>
            <h2>Footer</h2>
            <div class="cta-group">
                <a href="#logo" class="cta-1">Back to top</a>
            </div>
       </footer>

    </div>

    <div class="console">
        <span id="console-message">
            <b>Last events:</b> 
            <span id="console-message-gtm">
                form-submit, scroll, click
            </span>
        </span>
    </div>

    <script>
        // Newsletter AJAX form submission
        document.addEventListener('DOMContentLoaded', () => {
            const newsletterForm = document.getElementById('form-newsletter');
            const newsletterMessageDiv = document.getElementById('message-newsletter');
            const submitButton = newsletterForm ? newsletterForm.querySelector('button[type="submit"]') : null;
            const messageContainer = newsletterMessageDiv ? newsletterMessageDiv.parentElement : null;

            if (newsletterForm && newsletterMessageDiv && submitButton && messageContainer) {
                newsletterForm.addEventListener('submit', function(event) {
                    event.preventDefault(); 

                    const formData = new FormData(newsletterForm);
                    const actionUrl = newsletterForm.getAttribute('action');

                    // Reset message area: hide container, clear text, set base class
                    if (messageContainer) {
                        messageContainer.style.display = 'none'; 
                    }
                    newsletterMessageDiv.textContent = '';
                    newsletterMessageDiv.className = 'card'; // Base class
                    submitButton.disabled = true;
                    submitButton.textContent = 'Submitting...';

                    if (!actionUrl || actionUrl.trim() === '') {
                        newsletterMessageDiv.textContent = 'Error: Form submission endpoint is not configured.';
                        newsletterMessageDiv.classList.add('message-error'); // Add error class
                        if (messageContainer) {
                            messageContainer.style.display = 'block'; 
                        }
                        submitButton.disabled = false;
                        submitButton.textContent = 'Newsletter submit';
                        return;
                    }

                    fetch(actionUrl, {
                        method: 'POST',
                        body: formData,
                    })
                    .then(response => {
                        return response.text().then(text => {
                            if (!response.ok) {
                                // For !response.ok, create an Error object that includes the response text
                                let error = new Error(`Server error: ${response.status} ${response.statusText}.`);
                                error.responseText = text; // Attach the response text to the error object
                                throw error;
                            }
                            return text; // This is the success message from the webhook
                        });
                    })
                    .then(responseText => {
                        newsletterMessageDiv.textContent = responseText;
                        newsletterMessageDiv.classList.add('message-success'); // Add success class
                        if (messageContainer) {
                            messageContainer.style.display = 'block';
                        }
                        newsletterForm.reset(); 
                    })
                    .catch(error => {
                        console.error('Newsletter AJAX submission error:', error);
                        // If error has responseText (from !response.ok), use it. Otherwise, use error.message or a generic fallback.
                        newsletterMessageDiv.textContent = error.responseText || error.message || 'Submission failed. Please try again.';
                        newsletterMessageDiv.classList.add('message-error'); // Add error class
                        if (messageContainer) {
                            messageContainer.style.display = 'block'; 
                        }
                    })
                    .finally(() => {
                        submitButton.disabled = false;
                        submitButton.textContent = 'Newsletter submit';
                    });
                });
            } else {
                if (!newsletterForm) console.error('Newsletter form (form-newsletter) not found.');
                if (!newsletterMessageDiv) console.error('Newsletter message div (message-newsletter) not found.');
                if (!submitButton) console.error('Newsletter submit button not found.');
                if (!messageContainer) console.error('Message container (parent of message-newsletter) not found.');
            }
        });
    </script>

</body>
</html>